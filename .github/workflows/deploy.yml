name: Deploy Ionic Live Update
on:
  push:
    branches:
      - main
jobs:
  web-deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: 💻 Get the latest code
        uses: actions/checkout@v2.3.2
      - name: 📦 Setup Node.js
        uses: actions/setup-node@master
      - name: 💻 Install Ionic CLI
        run: npm install -g @ionic/cli
      - name: 📦 Install Ionic Dependencies
        run: npm install
      - name: ⭐️ Setting project as "production"
        run: npm run ensure-production
      - name: 🔨📲 Build Ionic Project (Native Live Update)
        run: npm run bundle-live-update
      - name: Get ZIP file name
        id: zip_file
        run: |
          zip_file=$(ls dist/*.zip | head -n 1)
          echo "::set-output name=zip_file::$zip_file"
      - name: Upload to distribution
        env:
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          curl --location --request POST 'https://maranatha.imedicineapp.com/api/app/native/bundles?bundle_name=${{ steps.zip_file.outputs.zip_file }}&secret_key=${{ env.APP_PRIVATE_KEY }}' \
              --form "file=@${{ steps.zip_file.outputs.zip_file }}"
