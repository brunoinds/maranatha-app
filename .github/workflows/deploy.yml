name: Deploy Ionic
on:
  push:
    branches:
      - none
jobs:
  native-live-update-deploy:
    name: ğŸ“² Native Live Update Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’» Get the latest code
        uses: actions/checkout@v4
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: ğŸ’» Install Ionic CLI
        run: npm install -g @ionic/cli
      - name: ğŸ“¦ Install Ionic Dependencies
        run: npm install
      - name: â­ï¸ Setting project as "production"
        run: npm run ensure-production
      - name: ğŸ“² Build Ionic Project (Native Live Update)
        run: npm run bundle-live-update
      - name: ğŸ—³ï¸ Get Bundle name
        id: zip_file
        run: |
          zip_file=$(ls dist/*.zip | head -n 1)
          echo "::set-output name=zip_file::$zip_file"
      - name: ğŸ“¤ Upload Bundle to distribution
        env:
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          curl --fail --location --request POST 'https://maranatha.top/api/app/native/bundles?secret_key=${{ env.APP_PRIVATE_KEY }}' \
              --form "file=@${{ steps.zip_file.outputs.zip_file }}"
  web-deploy:
    name: ğŸŒ Web Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’» Get the latest code
        uses: actions/checkout@v4
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: ğŸ’» Install Ionic CLI
        run: npm install -g @ionic/cli
      - name: ğŸ“¦ Install Ionic Dependencies
        run: npm install
      - name: â­ï¸ Setting project as "production"
        run: npm run ensure-production
      - name: ğŸ”¨ğŸŒ Build Ionic Project (Web)
        run: npm run bundle-web-update
      - name: ğŸ—³ï¸ Get Bundle name
        id: zip_file
        run: |
          zip_file=$(ls dist/*.zip | head -n 1)
          echo "::set-output name=zip_file::$zip_file"
      - name: ğŸ“¤ Upload Bundle to distribution
        env:
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          curl --fail --location --request POST 'https://maranatha.top/api/app/web/bundles?secret_key=${{ env.APP_PRIVATE_KEY }}' \
              --form "file=@${{ steps.zip_file.outputs.zip_file }}"